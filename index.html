<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Horas Clockify</title>
<style>
  body {
    font-family: 'Segoe UI', sans-serif;
    background: #f4f6fa;
    margin: 0;
    padding: 40px;
    color: #333;
  }

  h1 {
    text-align: center;
    color: #2c3e50;
    margin-bottom: 20px;
  }

  .api-key, .controls {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 20px;
  }

  input[type="text"], input[type="date"] {
    padding: 8px 12px;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 14px;
    background: #fff;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  }

  button {
    background-color: #3498db;
    color: white;
    border: none;
    padding: 8px 16px;
    font-size: 14px;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }

  button:hover {
    background-color: #2980b9;
  }

  .summary {
    text-align: center;
    margin-top: 20px;
    font-weight: bold;
    font-size: 18px;
    color: #2c3e50;
  }

  table {
    border-collapse: collapse;
    width: 100%;
    background: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    border-radius: 6px;
    overflow: hidden;
    margin-top: 30px;
  }

  th, td {
    padding: 12px 10px;
    text-align: center;
    border-bottom: 1px solid #eee;
  }

  th {
    background-color: #eaf4ff;
    font-weight: 600;
    color: #34495e;
  }

  tr:hover {
    background-color: #f1f9ff;
  }

  .loading {
    text-align: center;
    font-style: italic;
    color: #888;
    margin-top: 20px;
  }

  footer {
    text-align: center;
    margin-top: 50px;
    color: #bbb;
    font-size: 0.9em;
  }
</style>
</head>
<body>
  <h1>Relatório de Horas por Tarefa</h1>

  <div class="api-key">
    <input type="text" id="apiKeyInput" placeholder="Cole sua API Key do Clockify" style="width: 300px;" />
    <button onclick="inicializar()">Usar API Key</button>
  </div>

  <div class="controls">
    <label for="dataInicio">De:</label>
    <input type="date" id="dataInicio" onchange="filtrarPorDataRange()">
    <label for="dataFim">Até:</label>
    <input type="date" id="dataFim" onchange="filtrarPorDataRange()">
  </div>

  <div class="loading" id="loading">Carregando dados da Clockify...</div>

  <table id="tabela" style="display: none;">
    <thead>
      <tr>
        <th></th>
        <th>ID da Tarefa</th>
        <th>Data</th>
        <th>Análise (h)</th>
        <th>Pontos Análise</th>
        <th>Desenvolvimento (h)</th>
        <th>Pontos Dev</th>
        <th>Total (h)</th>
        <th>Total Pontos</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="summary">
    Pontuação Total Selecionada: <span id="pontuacaoTotal">0,00</span>
  </div>

  <h2 style="text-align:center; margin-top:60px;">Tarefas Finalizadas</h2>
  <table id="tabelaFinalizadas" style="display: none;">
    <thead>
      <tr>
        <th>ID da Tarefa</th>
        <th>Data</th>
        <th>Total Pontos</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <footer style="text-align: center; margin-top: 50px; color: #aaa; font-size: 0.9em;">
    &copy; 2025 Meneses. Todos os direitos reservados.
  </footer>

<script>
  let API_KEY = localStorage.getItem('apiKey') || '';
  let USER_ID = '';
  let WORKSPACE_ID = '';
  let tarefasGlobais = {};
  let finalizadas = JSON.parse(localStorage.getItem('finalizadas') || '[]');

  document.getElementById('apiKeyInput').value = API_KEY;

  const durationToSeconds = iso => {
    const regex = /PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/;
    const [, h = 0, m = 0, s = 0] = iso.match(regex).map(x => parseInt(x) || 0);
    return h * 3600 + m * 60 + s;
  };

  const calcularPontos = horas => {
    if (horas <= 1) return 0.2;
    if (horas <= 3) return 0.6;
    if (horas <= 6) return 1.2;
    if (horas <= 10) return 2.0;
    if (horas <= 15) return 3.0;
    if (horas <= 20) return 4.0;
    if (horas <= 30) return 6.0;
    return Math.floor(horas / 30) * 6.0;
  };

  const format = valor => new Intl.NumberFormat('pt-BR', { minimumFractionDigits: 2 }).format(valor);
  const formatarDuracao = segundos => [Math.floor(segundos / 3600), Math.floor((segundos % 3600) / 60), segundos % 60]
    .map(n => String(n).padStart(2, '0')).join(':');
  const formatarData = isoDate => new Date(isoDate).toLocaleDateString('pt-BR');

  async function inicializar() {
    API_KEY = document.getElementById('apiKeyInput').value.trim();
    if (!API_KEY) return alert('Insira uma API Key válida.');
    localStorage.setItem('apiKey', API_KEY);
    try {
      const res = await fetch('https://api.clockify.me/api/v1/user', {
        headers: { 'X-Api-Key': API_KEY }
      });
      const user = await res.json();
      USER_ID = user.id;
      WORKSPACE_ID = user.activeWorkspace;
      carregarDados();
    } catch (e) {
      alert('Erro ao validar API Key.');
      console.error(e);
    }
  }

  async function fetchHorasClockify() {
    const url = `https://api.clockify.me/api/v1/workspaces/${WORKSPACE_ID}/user/${USER_ID}/time-entries?hydrated=true&page-size=500`;
    const response = await fetch(url, { headers: { 'X-Api-Key': API_KEY } });
    const data = await response.json();
    if (!Array.isArray(data)) throw new Error('Resposta inesperada da API.');
    return data;
  }

  function agruparHorasPorTarefa(data) {
    const tarefas = {};
    data.forEach(entry => {
      const desc = entry.description || '';
      const match = desc.match(/(NMTZ-\d+)/);
      if (!match) return;
      const id = match[1];
      if (finalizadas.some(f => f.id === id)) return;
      const segundos = durationToSeconds(entry.timeInterval?.duration || '');
      const tags = Array.isArray(entry.tags) ? entry.tags.map(t => typeof t === 'string' ? t.toLowerCase() : t.name?.toLowerCase() || '') : [];
      if (!tarefas[id]) tarefas[id] = { analise: 0, desenvolvimento: 0, data: entry.timeInterval?.start || null };
      else if (entry.timeInterval?.start && new Date(entry.timeInterval.start) < new Date(tarefas[id].data)) tarefas[id].data = entry.timeInterval.start;
      if (tags.some(t => t.includes('análise') || t.includes('analise'))) tarefas[id].analise += segundos;
      else if (tags.some(t => t.includes('desenvolvimento'))) tarefas[id].desenvolvimento += segundos;
    });
    return tarefas;
  }

  function preencherTabela(tarefas) {
    const tbody = document.querySelector("#tabela tbody");
    tbody.innerHTML = '';
    Object.entries(tarefas).forEach(([id, t]) => {
      const analiseHoras = t.analise / 3600;
      const devHoras = t.desenvolvimento / 3600;
      const pontosAnalise = calcularPontos(analiseHoras);
      const pontosDev = calcularPontos(devHoras);
      const totalPontos = pontosAnalise + pontosDev;
      const row = document.createElement("tr");
      row.innerHTML = `
        <td><input type="checkbox" data-pontos="${totalPontos}" onchange="atualizarPontuacaoTotal()"></td>
        <td>${id}</td>
        <td>${formatarData(t.data)}</td>
        <td>${formatarDuracao(t.analise)}</td>
        <td>${format(pontosAnalise)}</td>
        <td>${formatarDuracao(t.desenvolvimento)}</td>
        <td>${format(pontosDev)}</td>
        <td>${formatarDuracao(t.analise + t.desenvolvimento)}</td>
        <td>${format(totalPontos)}</td>
        <td><button onclick="marcarComoFinalizada('${id}', '${t.data}', ${totalPontos})">Finalizar</button></td>
      `;
      tbody.appendChild(row);
    });
  }

  function atualizarPontuacaoTotal() {
    const checkboxes = document.querySelectorAll('tbody input[type="checkbox"]:checked');
    let total = 0;
    checkboxes.forEach(cb => total += parseFloat(cb.dataset.pontos));
    document.getElementById('pontuacaoTotal').textContent = format(total);
  }

  function marcarComoFinalizada(id, data, pontos) {
    if (!finalizadas.some(f => f.id === id)) {
      finalizadas.push({ id, data, pontos });
      localStorage.setItem('finalizadas', JSON.stringify(finalizadas));
      atualizarTabelaFinalizadas();
      delete tarefasGlobais[id];
      preencherTabela(tarefasGlobais);
    }
  }

  function atualizarTabelaFinalizadas() {
    const tabela = document.getElementById('tabelaFinalizadas');
    const tbody = tabela.querySelector('tbody');
    tbody.innerHTML = '';
    finalizadas.forEach(f => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${f.id}</td>
        <td>${formatarData(f.data)}</td>
        <td>${format(f.pontos)}</td>
      `;
      tbody.appendChild(row);
    });
    tabela.style.display = finalizadas.length > 0 ? 'table' : 'none';
  }

  function filtrarPorDataRange() {
    const inicio = document.getElementById('dataInicio').value;
    const fim = document.getElementById('dataFim').value;
    if (!inicio && !fim) return preencherTabela(tarefasGlobais);
    const startDate = inicio ? new Date(inicio) : new Date('1970-01-01');
    const endDate = fim ? new Date(fim) : new Date('9999-12-31');
    const filtradas = Object.fromEntries(
      Object.entries(tarefasGlobais).filter(([_, t]) => {
        const d = new Date(t.data);
        return d >= startDate && d <= endDate;
      })
    );
    preencherTabela(filtradas);
  }

  async function carregarDados() {
    const dados = await fetchHorasClockify();
    tarefasGlobais = agruparHorasPorTarefa(dados);
    atualizarTabelaFinalizadas();
    preencherTabela(tarefasGlobais);
    document.getElementById('loading').style.display = 'none';
    document.getElementById('tabela').style.display = 'table';
  }

  if (API_KEY) inicializar();
</script>
</body>
</html>
